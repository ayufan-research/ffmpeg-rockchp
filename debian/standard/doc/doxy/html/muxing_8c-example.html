<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FFmpeg: muxing.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FFmpeg
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">muxing.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Copyright (c) 2003 Fabrice Bellard</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Permission is hereby granted, free of charge, to any person obtaining a copy</span></div><div class="line"><span class="comment"> * of this software and associated documentation files (the &quot;Software&quot;), to deal</span></div><div class="line"><span class="comment"> * in the Software without restriction, including without limitation the rights</span></div><div class="line"><span class="comment"> * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span></div><div class="line"><span class="comment"> * copies of the Software, and to permit persons to whom the Software is</span></div><div class="line"><span class="comment"> * furnished to do so, subject to the following conditions:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The above copyright notice and this permission notice shall be included in</span></div><div class="line"><span class="comment"> * all copies or substantial portions of the Software.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></div><div class="line"><span class="comment"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span></div><div class="line"><span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL</span></div><div class="line"><span class="comment"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span></div><div class="line"><span class="comment"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span></div><div class="line"><span class="comment"> * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span></div><div class="line"><span class="comment"> * THE SOFTWARE.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @file</span></div><div class="line"><span class="comment"> * libavformat API example.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Output a media file in any supported libavformat format. The default</span></div><div class="line"><span class="comment"> * codecs are used.</span></div><div class="line"><span class="comment"> * @example muxing.c</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="avassert_8h.html">libavutil/avassert.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="channel__layout_8h.html">libavutil/channel_layout.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="opt_8h.html">libavutil/opt.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mathematics_8h.html">libavutil/mathematics.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timestamp_8h.html">libavutil/timestamp.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="avformat_8h.html">libavformat/avformat.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="swscale_8h.html">libswscale/swscale.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="swresample_8h.html">libswresample/swresample.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define STREAM_DURATION   10.0</span></div><div class="line"><span class="preprocessor">#define STREAM_FRAME_RATE 25 </span><span class="comment">/* 25 images/s */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define STREAM_PIX_FMT    AV_PIX_FMT_YUV420P </span><span class="comment">/* default pix_fmt */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="preprocessor">#define SCALE_FLAGS SWS_BICUBIC</span></div><div class="line"></div><div class="line"><span class="comment">// a wrapper around a single output AVStream</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structOutputStream.html">OutputStream</a> {</div><div class="line">    <a name="_a1"></a><a class="code" href="structAVStream.html">AVStream</a> *<a name="a2"></a><a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>;</div><div class="line">    <a name="_a3"></a><a class="code" href="structAVCodecContext.html">AVCodecContext</a> *<a name="a4"></a><a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>;</div><div class="line"></div><div class="line">    <span class="comment">/* pts of the next frame that will be generated */</span></div><div class="line">    int64_t <a name="a5"></a><a class="code" href="structOutputStream.html#aaa3b9001e4dac709017237c1c177cd0a">next_pts</a>;</div><div class="line">    <span class="keywordtype">int</span> <a name="a6"></a><a class="code" href="structOutputStream.html#a0c3b9816e5c50c0ed816343d224121e7">samples_count</a>;</div><div class="line"></div><div class="line">    <a name="_a7"></a><a class="code" href="structAVFrame.html">AVFrame</a> *<a name="a8"></a><a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>;</div><div class="line">    <a class="code" href="structAVFrame.html">AVFrame</a> *<a name="a9"></a><a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a>;</div><div class="line"></div><div class="line">    <span class="keywordtype">float</span> <a name="a10"></a><a class="code" href="structOutputStream.html#ab5bc1d10f171e32c5241ab23271ae765">t</a>, <a name="a11"></a><a class="code" href="structOutputStream.html#afacbd1335db05b68d2ea528c8b5d197b">tincr</a>, <a name="a12"></a><a class="code" href="structOutputStream.html#a04fe3fc54e1a382047e501c4ce63497b">tincr2</a>;</div><div class="line"></div><div class="line">    <span class="keyword">struct </span>SwsContext *<a name="a13"></a><a class="code" href="structOutputStream.html#a87e6c2172dab3143e4857aaaf6558573">sws_ctx</a>;</div><div class="line">    <span class="keyword">struct </span><a class="code" href="group__lswr.html#ga4aa775b7fba31d2c8dc14c7b7e282863">SwrContext</a> *<a name="a14"></a><a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>;</div><div class="line">} <a class="code" href="structOutputStream.html">OutputStream</a>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a15"></a><a class="code" href="muxing_8c.html#ac7a1319852323152629ce60c4ef04ed5">log_packet</a>(<span class="keyword">const</span> <a name="_a16"></a><a class="code" href="structAVFormatContext.html">AVFormatContext</a> *<a name="a17"></a><a class="code" href="demuxing__decoding_8c.html#a409462acdf7aebe5bfbe1bcd811efa5d">fmt_ctx</a>, <span class="keyword">const</span> <a name="_a18"></a><a class="code" href="structAVPacket.html">AVPacket</a> *<a name="a19"></a><a class="code" href="demuxing__decoding_8c.html#a3d4c6562f0b27cf0cacbbea5c038c090">pkt</a>)</div><div class="line">{</div><div class="line">    <a name="_a20"></a><a class="code" href="structAVRational.html">AVRational</a> *time_base = &amp;fmt_ctx-&gt;<a name="a21"></a><a class="code" href="structAVFormatContext.html#acfefb6b6cf21e87a0dcbd1a547ba2348">streams</a>[pkt-&gt;<a name="a22"></a><a class="code" href="structAVPacket.html#a0d1cb9b5a32b00fb6edc81ea3aae2a49">stream_index</a>]-&gt;<a name="a23"></a><a class="code" href="structAVStream.html#a9db755451f14e2bf590d4b85d82b32e6">time_base</a>;</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;pts:%s pts_time:%s dts:%s dts_time:%s duration:%s duration_time:%s stream_index:%d\n&quot;</span>,</div><div class="line">           <a name="a24"></a><a class="code" href="timestamp_8h.html#a86d797e907fa454ed5fd34bfb0bcd747">av_ts2str</a>(pkt-&gt;<a name="a25"></a><a class="code" href="structAVPacket.html#a73bde0a37f3b1efc839f11295bfbf42a">pts</a>), <a name="a26"></a><a class="code" href="timestamp_8h.html#ad344b91ede6b86fc0a530611293f42da">av_ts2timestr</a>(pkt-&gt;<a class="code" href="structAVPacket.html#a73bde0a37f3b1efc839f11295bfbf42a">pts</a>, time_base),</div><div class="line">           <a class="code" href="timestamp_8h.html#a86d797e907fa454ed5fd34bfb0bcd747">av_ts2str</a>(pkt-&gt;<a name="a27"></a><a class="code" href="structAVPacket.html#a85dbbd306b44b02390cd91c45e6a0f76">dts</a>), <a class="code" href="timestamp_8h.html#ad344b91ede6b86fc0a530611293f42da">av_ts2timestr</a>(pkt-&gt;<a class="code" href="structAVPacket.html#a85dbbd306b44b02390cd91c45e6a0f76">dts</a>, time_base),</div><div class="line">           <a class="code" href="timestamp_8h.html#a86d797e907fa454ed5fd34bfb0bcd747">av_ts2str</a>(pkt-&gt;<a name="a28"></a><a class="code" href="structAVPacket.html#a622e758be29fd500aed0ffdc069550f7">duration</a>), <a class="code" href="timestamp_8h.html#ad344b91ede6b86fc0a530611293f42da">av_ts2timestr</a>(pkt-&gt;<a class="code" href="structAVPacket.html#a622e758be29fd500aed0ffdc069550f7">duration</a>, time_base),</div><div class="line">           pkt-&gt;<a class="code" href="structAVPacket.html#a0d1cb9b5a32b00fb6edc81ea3aae2a49">stream_index</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a29"></a><a class="code" href="muxing_8c.html#ab85f450fd9ee7aad777fc135b62dd3cd">write_frame</a>(<a class="code" href="structAVFormatContext.html">AVFormatContext</a> *fmt_ctx, <span class="keyword">const</span> <a class="code" href="structAVRational.html">AVRational</a> *time_base, <a class="code" href="structAVStream.html">AVStream</a> *<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>, <a class="code" href="structAVPacket.html">AVPacket</a> *pkt)</div><div class="line">{</div><div class="line">    <span class="comment">/* rescale output packet timestamp values from codec to stream timebase */</span></div><div class="line">    <a name="a30"></a><a class="code" href="group__lavc__packet.html#gae5c86e4d93f6e7aa62ef2c60763ea67e">av_packet_rescale_ts</a>(pkt, *time_base, st-&gt;<a class="code" href="structAVStream.html#a9db755451f14e2bf590d4b85d82b32e6">time_base</a>);</div><div class="line">    pkt-&gt;<a class="code" href="structAVPacket.html#a0d1cb9b5a32b00fb6edc81ea3aae2a49">stream_index</a> = st-&gt;<a name="a31"></a><a class="code" href="structAVStream.html#a6ca823054632821e085377f7d371a2d1">index</a>;</div><div class="line"></div><div class="line">    <span class="comment">/* Write the compressed frame to the media file. */</span></div><div class="line">    <a class="code" href="muxing_8c.html#ac7a1319852323152629ce60c4ef04ed5">log_packet</a>(fmt_ctx, pkt);</div><div class="line">    <span class="keywordflow">return</span> <a name="a32"></a><a class="code" href="group__lavf__encoding.html#ga37352ed2c63493c38219d935e71db6c1">av_interleaved_write_frame</a>(fmt_ctx, pkt);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Add an output stream. */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a33"></a><a class="code" href="muxing_8c.html#aead090f3b6525cfdfa572f18f7575219">add_stream</a>(<a class="code" href="structOutputStream.html">OutputStream</a> *ost, <a class="code" href="structAVFormatContext.html">AVFormatContext</a> *oc,</div><div class="line">                       <a name="_a34"></a><a class="code" href="structAVCodec.html">AVCodec</a> **codec,</div><div class="line">                       <span class="keyword">enum</span> <a class="code" href="group__lavc__core.html#gaadca229ad2c20e060a14fec08a5cc7ce">AVCodecID</a> codec_id)</div><div class="line">{</div><div class="line">    <a class="code" href="structAVCodecContext.html">AVCodecContext</a> *c;</div><div class="line">    <span class="keywordtype">int</span> i;</div><div class="line"></div><div class="line">    <span class="comment">/* find the encoder */</span></div><div class="line">    *codec = <a name="a35"></a><a class="code" href="group__lavc__encoding.html#ga9f820c481615c3a02d0407bac0bdbf25">avcodec_find_encoder</a>(codec_id);</div><div class="line">    <span class="keywordflow">if</span> (!(*codec)) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not find encoder for &#39;%s&#39;\n&quot;</span>,</div><div class="line">                <a name="a36"></a><a class="code" href="group__lavc__misc.html#ga2016a52e94f867ebe5113bdf448e182d">avcodec_get_name</a>(codec_id));</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a> = <a name="a37"></a><a class="code" href="group__lavf__core.html#gadcb0fd3e507d9b58fe78f61f8ad39827">avformat_new_stream</a>(oc, NULL);</div><div class="line">    <span class="keywordflow">if</span> (!ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not allocate stream\n&quot;</span>);</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>-&gt;<a name="a38"></a><a class="code" href="structAVStream.html#a6873ed62f196c24e8bf282609231786f">id</a> = oc-&gt;<a name="a39"></a><a class="code" href="structAVFormatContext.html#a0b748d924898b08b89ff4974afd17285">nb_streams</a>-1;</div><div class="line">    c = <a name="a40"></a><a class="code" href="group__lavc__core.html#gae80afec6f26df6607eaacf39b561c315">avcodec_alloc_context3</a>(*codec);</div><div class="line">    <span class="keywordflow">if</span> (!c) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not alloc an encoding context\n&quot;</span>);</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a> = c;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> ((*codec)-&gt;type) {</div><div class="line">    <span class="keywordflow">case</span> <a name="a41"></a><a class="code" href="group__lavu__misc.html#gga9a84bba4713dfced21a1a56163be1f48a7b4e33b8f30ac94d34ce8d9f7c33927a">AVMEDIA_TYPE_AUDIO</a>:</div><div class="line">        c-&gt;<a name="a42"></a><a class="code" href="structAVCodecContext.html#a1bdba69ea111e2a9d03fdaa7a46a4c45">sample_fmt</a>  = (*codec)-&gt;sample_fmts ?</div><div class="line">            (*codec)-&gt;sample_fmts[0] : <a name="a43"></a><a class="code" href="group__lavu__sampfmts.html#ggaf9a51ca15301871723577c730b5865c5a2d21c520e4ab21100b6440ec2d81ba1b">AV_SAMPLE_FMT_FLTP</a>;</div><div class="line">        c-&gt;<a name="a44"></a><a class="code" href="structAVCodecContext.html#a6b53fda85ad61baa345edbd96cb8a33c">bit_rate</a>    = 64000;</div><div class="line">        c-&gt;<a name="a45"></a><a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a> = 44100;</div><div class="line">        <span class="keywordflow">if</span> ((*codec)-&gt;supported_samplerates) {</div><div class="line">            c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a> = (*codec)-&gt;supported_samplerates[0];</div><div class="line">            <span class="keywordflow">for</span> (i = 0; (*codec)-&gt;supported_samplerates[i]; i++) {</div><div class="line">                <span class="keywordflow">if</span> ((*codec)-&gt;supported_samplerates[i] == 44100)</div><div class="line">                    c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a> = 44100;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        c-&gt;<a name="a46"></a><a class="code" href="structAVCodecContext.html#ac1e6c2cd1269caa7570575725c682a49">channels</a>        = <a name="a47"></a><a class="code" href="group__channel__mask__c.html#gac95619abeb32e4a3daa18e3ff3419380">av_get_channel_layout_nb_channels</a>(c-&gt;<a name="a48"></a><a class="code" href="structAVCodecContext.html#aeb08c575a79eb84fc4155dda88f46c06">channel_layout</a>);</div><div class="line">        c-&gt;<a class="code" href="structAVCodecContext.html#aeb08c575a79eb84fc4155dda88f46c06">channel_layout</a> = <a name="a49"></a><a class="code" href="group__channel__mask__c.html#gabc6d6651bba254cd0fa2c42a57228e65">AV_CH_LAYOUT_STEREO</a>;</div><div class="line">        <span class="keywordflow">if</span> ((*codec)-&gt;channel_layouts) {</div><div class="line">            c-&gt;<a class="code" href="structAVCodecContext.html#aeb08c575a79eb84fc4155dda88f46c06">channel_layout</a> = (*codec)-&gt;channel_layouts[0];</div><div class="line">            <span class="keywordflow">for</span> (i = 0; (*codec)-&gt;channel_layouts[i]; i++) {</div><div class="line">                <span class="keywordflow">if</span> ((*codec)-&gt;channel_layouts[i] == <a class="code" href="group__channel__mask__c.html#gabc6d6651bba254cd0fa2c42a57228e65">AV_CH_LAYOUT_STEREO</a>)</div><div class="line">                    c-&gt;<a class="code" href="structAVCodecContext.html#aeb08c575a79eb84fc4155dda88f46c06">channel_layout</a> = <a class="code" href="group__channel__mask__c.html#gabc6d6651bba254cd0fa2c42a57228e65">AV_CH_LAYOUT_STEREO</a>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        c-&gt;<a class="code" href="structAVCodecContext.html#ac1e6c2cd1269caa7570575725c682a49">channels</a>        = <a class="code" href="group__channel__mask__c.html#gac95619abeb32e4a3daa18e3ff3419380">av_get_channel_layout_nb_channels</a>(c-&gt;<a class="code" href="structAVCodecContext.html#aeb08c575a79eb84fc4155dda88f46c06">channel_layout</a>);</div><div class="line">        ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>-&gt;<a class="code" href="structAVStream.html#a9db755451f14e2bf590d4b85d82b32e6">time_base</a> = (<a class="code" href="structAVRational.html">AVRational</a>){ 1, c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a> };</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a name="a50"></a><a class="code" href="group__lavu__misc.html#gga9a84bba4713dfced21a1a56163be1f48ac1a46f59be5c6c2d3412ab172d6b8cf5">AVMEDIA_TYPE_VIDEO</a>:</div><div class="line">        c-&gt;<a name="a51"></a><a class="code" href="structAVCodecContext.html#adc5f65d6099fd8339c1580c091777223">codec_id</a> = codec_id;</div><div class="line"></div><div class="line">        c-&gt;<a class="code" href="structAVCodecContext.html#a6b53fda85ad61baa345edbd96cb8a33c">bit_rate</a> = 400000;</div><div class="line">        <span class="comment">/* Resolution must be a multiple of two. */</span></div><div class="line">        c-&gt;<a name="a52"></a><a class="code" href="structAVCodecContext.html#a0d8f46461754e8abea0847dcbc41b956">width</a>    = 352;</div><div class="line">        c-&gt;<a name="a53"></a><a class="code" href="structAVCodecContext.html#a0449afd803eb107bd4dbc8b5ea22e363">height</a>   = 288;</div><div class="line">        <span class="comment">/* timebase: This is the fundamental unit of time (in seconds) in terms</span></div><div class="line"><span class="comment">         * of which frame timestamps are represented. For fixed-fps content,</span></div><div class="line"><span class="comment">         * timebase should be 1/framerate and timestamp increments should be</span></div><div class="line"><span class="comment">         * identical to 1. */</span></div><div class="line">        ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>-&gt;<a class="code" href="structAVStream.html#a9db755451f14e2bf590d4b85d82b32e6">time_base</a> = (<a class="code" href="structAVRational.html">AVRational</a>){ 1, <a name="a54"></a><a class="code" href="muxing_8c.html#ad0fa7a6ac51a4021276c0a04dfe2283b">STREAM_FRAME_RATE</a> };</div><div class="line">        c-&gt;<a name="a55"></a><a class="code" href="structAVCodecContext.html#ab7bfeb9fa5840aac090e2b0bd0ef7589">time_base</a>       = ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>-&gt;<a class="code" href="structAVStream.html#a9db755451f14e2bf590d4b85d82b32e6">time_base</a>;</div><div class="line"></div><div class="line">        c-&gt;<a name="a56"></a><a class="code" href="structAVCodecContext.html#a9b6b3f1fcbdcc2ad9f4dbb4370496e38">gop_size</a>      = 12; <span class="comment">/* emit one intra frame every twelve frames at most */</span></div><div class="line">        c-&gt;<a name="a57"></a><a class="code" href="structAVCodecContext.html#a0425c77b3d06d71e5db88b1d7e1b37f2">pix_fmt</a>       = <a name="a58"></a><a class="code" href="muxing_8c.html#ae67b157ab0198fa81bf675b378ff06fd">STREAM_PIX_FMT</a>;</div><div class="line">        <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structAVCodecContext.html#adc5f65d6099fd8339c1580c091777223">codec_id</a> == <a name="a59"></a><a class="code" href="group__lavc__core.html#ggaadca229ad2c20e060a14fec08a5cc7ceaf614abb36f7c5d0c42ed522c1d6c99f0">AV_CODEC_ID_MPEG2VIDEO</a>) {</div><div class="line">            <span class="comment">/* just for testing, we also add B-frames */</span></div><div class="line">            c-&gt;<a name="a60"></a><a class="code" href="structAVCodecContext.html#a3e5334a611a3e2a6a653805bb9e2d4d4">max_b_frames</a> = 2;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structAVCodecContext.html#adc5f65d6099fd8339c1580c091777223">codec_id</a> == <a name="a61"></a><a class="code" href="group__lavc__core.html#ggaadca229ad2c20e060a14fec08a5cc7ceaf019b13f4891b36ae579cd7bc96d1f78">AV_CODEC_ID_MPEG1VIDEO</a>) {</div><div class="line">            <span class="comment">/* Needed to avoid using macroblocks in which some coeffs overflow.</span></div><div class="line"><span class="comment">             * This does not happen with normal video, it just happens here as</span></div><div class="line"><span class="comment">             * the motion of the chroma plane does not match the luma plane. */</span></div><div class="line">            c-&gt;<a name="a62"></a><a class="code" href="structAVCodecContext.html#a66af0e26734255f1eacabd7d67558482">mb_decision</a> = 2;</div><div class="line">        }</div><div class="line">    <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Some formats want stream headers to be separate. */</span></div><div class="line">    <span class="keywordflow">if</span> (oc-&gt;<a name="a63"></a><a class="code" href="structAVFormatContext.html#a20d80ac07e38ff5c268d15aaf2798b98">oformat</a>-&gt;<a name="a64"></a><a class="code" href="structAVOutputFormat.html#aad55a00e728a020c1dcfaaf695320445">flags</a> &amp; <a name="a65"></a><a class="code" href="avformat_8h.html#ab203c7b734e9c31b7c37d34f6e2c6aef">AVFMT_GLOBALHEADER</a>)</div><div class="line">        c-&gt;<a name="a66"></a><a class="code" href="structAVCodecContext.html#abb01e291550fa3fb96188af4d494587e">flags</a> |= <a name="a67"></a><a class="code" href="group__lavc__core.html#ga9ed82634c59b339786575827c47a8f68">AV_CODEC_FLAG_GLOBAL_HEADER</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**************************************************************/</span></div><div class="line"><span class="comment">/* audio output */</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="structAVFrame.html">AVFrame</a> *<a name="a68"></a><a class="code" href="muxing_8c.html#a368b2deb0a63160293db69808acfeff2">alloc_audio_frame</a>(<span class="keyword">enum</span> <a class="code" href="group__lavu__sampfmts.html#gaf9a51ca15301871723577c730b5865c5">AVSampleFormat</a> sample_fmt,</div><div class="line">                                  uint64_t channel_layout,</div><div class="line">                                  <span class="keywordtype">int</span> sample_rate, <span class="keywordtype">int</span> nb_samples)</div><div class="line">{</div><div class="line">    <a class="code" href="structAVFrame.html">AVFrame</a> *<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a> = <a name="a69"></a><a class="code" href="group__lavu__frame.html#gac700017c5270c79c1e1befdeeb008b2f">av_frame_alloc</a>();</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!frame) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error allocating an audio frame\n&quot;</span>);</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    frame-&gt;<a name="a70"></a><a class="code" href="structAVFrame.html#aed14fa772ce46881020fd1545c86432c">format</a> = sample_fmt;</div><div class="line">    frame-&gt;<a name="a71"></a><a class="code" href="structAVFrame.html#a5f343e0325e3e9d9ed20e34c9e156aef">channel_layout</a> = channel_layout;</div><div class="line">    frame-&gt;<a name="a72"></a><a class="code" href="structAVFrame.html#ac85daa1316e1f47e78da0ca19b7c60e6">sample_rate</a> = sample_rate;</div><div class="line">    frame-&gt;<a name="a73"></a><a class="code" href="structAVFrame.html#a02f45ab8191aea1660159f1e464237ea">nb_samples</a> = nb_samples;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (nb_samples) {</div><div class="line">        ret = <a name="a74"></a><a class="code" href="group__lavu__frame.html#ga6b1acbfa82c79bf7fd78d868572f0ceb">av_frame_get_buffer</a>(frame, 0);</div><div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Error allocating an audio buffer\n&quot;</span>);</div><div class="line">            exit(1);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a75"></a><a class="code" href="muxing_8c.html#ae7697b74a6a8605a91487b43e31f29be">open_audio</a>(<a class="code" href="structAVFormatContext.html">AVFormatContext</a> *oc, <a class="code" href="structAVCodec.html">AVCodec</a> *codec, <a class="code" href="structOutputStream.html">OutputStream</a> *ost, <a class="code" href="group__lavu__dict.html#ga1d7cc0833bee918994a600556410315f">AVDictionary</a> *opt_arg)</div><div class="line">{</div><div class="line">    <a class="code" href="structAVCodecContext.html">AVCodecContext</a> *c;</div><div class="line">    <span class="keywordtype">int</span> nb_samples;</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    <a class="code" href="group__lavu__dict.html#ga1d7cc0833bee918994a600556410315f">AVDictionary</a> *opt = NULL;</div><div class="line"></div><div class="line">    c = ost-&gt;<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>;</div><div class="line"></div><div class="line">    <span class="comment">/* open it */</span></div><div class="line">    <a name="a76"></a><a class="code" href="group__lavu__dict.html#ga59a6372b124b306e3a2233723c5cdc78">av_dict_copy</a>(&amp;opt, opt_arg, 0);</div><div class="line">    ret = <a name="a77"></a><a class="code" href="group__lavc__core.html#ga11f785a188d7d9df71621001465b0f1d">avcodec_open2</a>(c, codec, &amp;opt);</div><div class="line">    <a name="a78"></a><a class="code" href="group__lavu__dict.html#ga1bafd682b1fbb90e48a4cc3814b820f7">av_dict_free</a>(&amp;opt);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not open audio codec: %s\n&quot;</span>, <a name="a79"></a><a class="code" href="group__lavu__error.html#gac4f6e109c242c81aeee21868d3f35e12">av_err2str</a>(ret));</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* init signal generator */</span></div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#ab5bc1d10f171e32c5241ab23271ae765">t</a>     = 0;</div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#afacbd1335db05b68d2ea528c8b5d197b">tincr</a> = 2 * <a name="a80"></a><a class="code" href="mathematics_8h.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * 110.0 / c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a>;</div><div class="line">    <span class="comment">/* increment frequency by 110 Hz per second */</span></div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#a04fe3fc54e1a382047e501c4ce63497b">tincr2</a> = 2 * <a class="code" href="mathematics_8h.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * 110.0 / c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a> / c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (c-&gt;<a name="a81"></a><a class="code" href="structAVCodecContext.html#a6e606effa68724cae2ef5cc05f7fd9cb">codec</a>-&gt;<a name="a82"></a><a class="code" href="structAVCodec.html#af51f7ff3dac8b730f46b9713e49a2518">capabilities</a> &amp; <a name="a83"></a><a class="code" href="group__lavc__core.html#ga38b16ee9a8fd4c57ffd4fef0db3481c6">AV_CODEC_CAP_VARIABLE_FRAME_SIZE</a>)</div><div class="line">        nb_samples = 10000;</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">        nb_samples = c-&gt;<a name="a84"></a><a class="code" href="structAVCodecContext.html#aec57f0d859a6df8b479cd93ca3a44a33">frame_size</a>;</div><div class="line"></div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>     = <a class="code" href="muxing_8c.html#a368b2deb0a63160293db69808acfeff2">alloc_audio_frame</a>(c-&gt;<a class="code" href="structAVCodecContext.html#a1bdba69ea111e2a9d03fdaa7a46a4c45">sample_fmt</a>, c-&gt;<a class="code" href="structAVCodecContext.html#aeb08c575a79eb84fc4155dda88f46c06">channel_layout</a>,</div><div class="line">                                       c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a>, nb_samples);</div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a> = <a class="code" href="muxing_8c.html#a368b2deb0a63160293db69808acfeff2">alloc_audio_frame</a>(<a name="a85"></a><a class="code" href="group__lavu__sampfmts.html#ggaf9a51ca15301871723577c730b5865c5aea6132df57aebc3f76e10665395c46af">AV_SAMPLE_FMT_S16</a>, c-&gt;<a class="code" href="structAVCodecContext.html#aeb08c575a79eb84fc4155dda88f46c06">channel_layout</a>,</div><div class="line">                                       c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a>, nb_samples);</div><div class="line"></div><div class="line">    <span class="comment">/* copy the stream parameters to the muxer */</span></div><div class="line">    ret = <a name="a86"></a><a class="code" href="group__lavc__core.html#ga0c7058f764778615e7978a1821ab3cfe">avcodec_parameters_from_context</a>(ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>-&gt;<a name="a87"></a><a class="code" href="structAVStream.html#a12826d21779289356722971d362c583c">codecpar</a>, c);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not copy the stream parameters\n&quot;</span>);</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* create resampler context */</span></div><div class="line">        ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a> = <a name="a88"></a><a class="code" href="group__lswr.html#gaf58c4ff10f73d74bdab8e5aa7193147c">swr_alloc</a>();</div><div class="line">        <span class="keywordflow">if</span> (!ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not allocate resampler context\n&quot;</span>);</div><div class="line">            exit(1);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* set options */</span></div><div class="line">        <a name="a89"></a><a class="code" href="group__opt__set__funcs.html#ga3adf7185c21cc080890a5ec02c2e56b2">av_opt_set_int</a>       (ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>, <span class="stringliteral">&quot;in_channel_count&quot;</span>,   c-&gt;<a class="code" href="structAVCodecContext.html#ac1e6c2cd1269caa7570575725c682a49">channels</a>,       0);</div><div class="line">        <a class="code" href="group__opt__set__funcs.html#ga3adf7185c21cc080890a5ec02c2e56b2">av_opt_set_int</a>       (ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>, <span class="stringliteral">&quot;in_sample_rate&quot;</span>,     c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a>,    0);</div><div class="line">        <a name="a90"></a><a class="code" href="group__opt__set__funcs.html#gad446f7a7b92442e464d43e400e661040">av_opt_set_sample_fmt</a>(ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>, <span class="stringliteral">&quot;in_sample_fmt&quot;</span>,      <a class="code" href="group__lavu__sampfmts.html#ggaf9a51ca15301871723577c730b5865c5aea6132df57aebc3f76e10665395c46af">AV_SAMPLE_FMT_S16</a>, 0);</div><div class="line">        <a class="code" href="group__opt__set__funcs.html#ga3adf7185c21cc080890a5ec02c2e56b2">av_opt_set_int</a>       (ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>, <span class="stringliteral">&quot;out_channel_count&quot;</span>,  c-&gt;<a class="code" href="structAVCodecContext.html#ac1e6c2cd1269caa7570575725c682a49">channels</a>,       0);</div><div class="line">        <a class="code" href="group__opt__set__funcs.html#ga3adf7185c21cc080890a5ec02c2e56b2">av_opt_set_int</a>       (ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>, <span class="stringliteral">&quot;out_sample_rate&quot;</span>,    c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a>,    0);</div><div class="line">        <a class="code" href="group__opt__set__funcs.html#gad446f7a7b92442e464d43e400e661040">av_opt_set_sample_fmt</a>(ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>, <span class="stringliteral">&quot;out_sample_fmt&quot;</span>,     c-&gt;<a class="code" href="structAVCodecContext.html#a1bdba69ea111e2a9d03fdaa7a46a4c45">sample_fmt</a>,     0);</div><div class="line"></div><div class="line">        <span class="comment">/* initialize the resampling context */</span></div><div class="line">        <span class="keywordflow">if</span> ((ret = <a name="a91"></a><a class="code" href="group__lswr.html#gae173e8ed91717700471a1dcd06f00f67">swr_init</a>(ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>)) &lt; 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to initialize the resampling context\n&quot;</span>);</div><div class="line">            exit(1);</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Prepare a 16 bit dummy audio frame of &#39;frame_size&#39; samples and</span></div><div class="line"><span class="comment"> * &#39;nb_channels&#39; channels. */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="structAVFrame.html">AVFrame</a> *<a name="a92"></a><a class="code" href="muxing_8c.html#a58000b15271c25fa9b2839d82f6971dc">get_audio_frame</a>(<a class="code" href="structOutputStream.html">OutputStream</a> *ost)</div><div class="line">{</div><div class="line">    <a class="code" href="structAVFrame.html">AVFrame</a> *<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a> = ost-&gt;<a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a>;</div><div class="line">    <span class="keywordtype">int</span> j, i, v;</div><div class="line">    int16_t *q = (int16_t*)frame-&gt;<a name="a93"></a><a class="code" href="structAVFrame.html#a1d0f65014a8d1bf78cec8cbed2304992">data</a>[0];</div><div class="line"></div><div class="line">    <span class="comment">/* check if we want to generate more frames */</span></div><div class="line">    if (<a name="a94"></a><a class="code" href="group__lavu__math.html#ga151744358fff630942b926e67e67c415">av_compare_ts</a>(ost-&gt;<a class="code" href="structOutputStream.html#aaa3b9001e4dac709017237c1c177cd0a">next_pts</a>, ost-&gt;<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>-&gt;<a class="code" href="structAVCodecContext.html#ab7bfeb9fa5840aac090e2b0bd0ef7589">time_base</a>,</div><div class="line">                      <a name="a95"></a><a class="code" href="muxing_8c.html#ace0cad5fe744009aeaa62eb1fbb31831">STREAM_DURATION</a>, (<a class="code" href="structAVRational.html">AVRational</a>){ 1, 1 }) &gt;= 0)</div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (j = 0; j &lt;frame-&gt;<a class="code" href="structAVFrame.html#a02f45ab8191aea1660159f1e464237ea">nb_samples</a>; j++) {</div><div class="line">        v = (int)(sin(ost-&gt;<a class="code" href="structOutputStream.html#ab5bc1d10f171e32c5241ab23271ae765">t</a>) * 10000);</div><div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; ost-&gt;<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>-&gt;<a class="code" href="structAVCodecContext.html#ac1e6c2cd1269caa7570575725c682a49">channels</a>; i++)</div><div class="line">            *q++ = v;</div><div class="line">        ost-&gt;<a class="code" href="structOutputStream.html#ab5bc1d10f171e32c5241ab23271ae765">t</a>     += ost-&gt;<a class="code" href="structOutputStream.html#afacbd1335db05b68d2ea528c8b5d197b">tincr</a>;</div><div class="line">        ost-&gt;<a class="code" href="structOutputStream.html#afacbd1335db05b68d2ea528c8b5d197b">tincr</a> += ost-&gt;<a class="code" href="structOutputStream.html#a04fe3fc54e1a382047e501c4ce63497b">tincr2</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    frame-&gt;<a name="a96"></a><a class="code" href="structAVFrame.html#a0452833e3ab6ddd7acbf82817a7818a4">pts</a> = ost-&gt;<a class="code" href="structOutputStream.html#aaa3b9001e4dac709017237c1c177cd0a">next_pts</a>;</div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#aaa3b9001e4dac709017237c1c177cd0a">next_pts</a>  += frame-&gt;<a class="code" href="structAVFrame.html#a02f45ab8191aea1660159f1e464237ea">nb_samples</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * encode one audio frame and send it to the muxer</span></div><div class="line"><span class="comment"> * return 1 when encoding is finished, 0 otherwise</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a97"></a><a class="code" href="muxing_8c.html#a789f35413429ab70610c90c22fc7a4d3">write_audio_frame</a>(<a class="code" href="structAVFormatContext.html">AVFormatContext</a> *oc, <a class="code" href="structOutputStream.html">OutputStream</a> *ost)</div><div class="line">{</div><div class="line">    <a class="code" href="structAVCodecContext.html">AVCodecContext</a> *c;</div><div class="line">    <a class="code" href="structAVPacket.html">AVPacket</a> pkt = { 0 }; <span class="comment">// data and size must be 0;</span></div><div class="line">    <a class="code" href="structAVFrame.html">AVFrame</a> *<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>;</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    <span class="keywordtype">int</span> got_packet;</div><div class="line">    <span class="keywordtype">int</span> dst_nb_samples;</div><div class="line"></div><div class="line">    <a name="a98"></a><a class="code" href="group__lavc__packet.html#gac9cb9756175b96e7441575803757fb73">av_init_packet</a>(&amp;pkt);</div><div class="line">    c = ost-&gt;<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>;</div><div class="line"></div><div class="line">    frame = <a class="code" href="muxing_8c.html#a58000b15271c25fa9b2839d82f6971dc">get_audio_frame</a>(ost);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (frame) {</div><div class="line">        <span class="comment">/* convert samples from native format to destination codec format, using the resampler */</span></div><div class="line">            <span class="comment">/* compute destination number of samples */</span></div><div class="line">            dst_nb_samples = <a name="a99"></a><a class="code" href="group__lavu__math.html#ga82d40664213508918093822461cc597e">av_rescale_rnd</a>(<a name="a100"></a><a class="code" href="group__lswr.html#ga5121a5a7890a2d23b72dc871dd0ebb06">swr_get_delay</a>(ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a>) + frame-&gt;<a class="code" href="structAVFrame.html#a02f45ab8191aea1660159f1e464237ea">nb_samples</a>,</div><div class="line">                                            c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a8ff0b000c463361e234af48d03aadfc0">sample_rate</a>, <a name="a101"></a><a class="code" href="group__lavu__math.html#gga921d656eaf2c4d6800a734a13af021d0aa1d28e08e2f8b49b256e056f93038c1a">AV_ROUND_UP</a>);</div><div class="line">            <a name="a102"></a><a class="code" href="avassert_8h.html#aae204192396f78cc8c5cd7ad5c57c23f">av_assert0</a>(dst_nb_samples == frame-&gt;<a class="code" href="structAVFrame.html#a02f45ab8191aea1660159f1e464237ea">nb_samples</a>);</div><div class="line"></div><div class="line">        <span class="comment">/* when we pass a frame to the encoder, it may keep a reference to it</span></div><div class="line"><span class="comment">         * internally;</span></div><div class="line"><span class="comment">         * make sure we do not overwrite it here</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        ret = <a name="a103"></a><a class="code" href="group__lavu__frame.html#gadd5417c06f5a6b419b0dbd8f0ff363fd">av_frame_make_writable</a>(ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>);</div><div class="line">        <span class="keywordflow">if</span> (ret &lt; 0)</div><div class="line">            exit(1);</div><div class="line"></div><div class="line">        <span class="comment">/* convert to destination format */</span></div><div class="line">        ret = <a name="a104"></a><a class="code" href="group__lswr.html#gaa5bb6cab830146efa8c760fa66ee582a">swr_convert</a>(ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>,</div><div class="line">                          ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>-&gt;<a class="code" href="structAVFrame.html#a1d0f65014a8d1bf78cec8cbed2304992">data</a>, dst_nb_samples,</div><div class="line">                          (<span class="keyword">const</span> uint8_t **)frame-&gt;<a class="code" href="structAVFrame.html#a1d0f65014a8d1bf78cec8cbed2304992">data</a>, frame-&gt;<a class="code" href="structAVFrame.html#a02f45ab8191aea1660159f1e464237ea">nb_samples</a>);</div><div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Error while converting\n&quot;</span>);</div><div class="line">            exit(1);</div><div class="line">        }</div><div class="line">        frame = ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>;</div><div class="line"></div><div class="line">        frame-&gt;<a class="code" href="structAVFrame.html#a0452833e3ab6ddd7acbf82817a7818a4">pts</a> = <a name="a105"></a><a class="code" href="group__lavu__math.html#gaf02994a8bbeaa91d4757df179cbe567f">av_rescale_q</a>(ost-&gt;<a class="code" href="structOutputStream.html#a0c3b9816e5c50c0ed816343d224121e7">samples_count</a>, (<a class="code" href="structAVRational.html">AVRational</a>){1, c-&gt;sample_rate}, c-&gt;<a class="code" href="structAVCodecContext.html#ab7bfeb9fa5840aac090e2b0bd0ef7589">time_base</a>);</div><div class="line">        ost-&gt;<a class="code" href="structOutputStream.html#a0c3b9816e5c50c0ed816343d224121e7">samples_count</a> += dst_nb_samples;</div><div class="line">    }</div><div class="line"></div><div class="line">    ret = <a name="a106"></a><a class="code" href="group__lavc__encoding.html#gae4b5ba4d50b1264a5cf5408ff32fb622">avcodec_encode_audio2</a>(c, &amp;pkt, frame, &amp;got_packet);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error encoding audio frame: %s\n&quot;</span>, <a class="code" href="group__lavu__error.html#gac4f6e109c242c81aeee21868d3f35e12">av_err2str</a>(ret));</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (got_packet) {</div><div class="line">        ret = <a class="code" href="muxing_8c.html#ab85f450fd9ee7aad777fc135b62dd3cd">write_frame</a>(oc, &amp;c-&gt;<a class="code" href="structAVCodecContext.html#ab7bfeb9fa5840aac090e2b0bd0ef7589">time_base</a>, ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>, &amp;pkt);</div><div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Error while writing audio frame: %s\n&quot;</span>,</div><div class="line">                    <a class="code" href="group__lavu__error.html#gac4f6e109c242c81aeee21868d3f35e12">av_err2str</a>(ret));</div><div class="line">            exit(1);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (frame || got_packet) ? 0 : 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**************************************************************/</span></div><div class="line"><span class="comment">/* video output */</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="structAVFrame.html">AVFrame</a> *<a name="a107"></a><a class="code" href="muxing_8c.html#a03824343735e44b58ec03ff1691f8b45">alloc_picture</a>(<span class="keyword">enum</span> <a class="code" href="pixfmt_8h.html#a9a8e335cf3be472042bc9f0cf80cd4c5">AVPixelFormat</a> <a name="a108"></a><a class="code" href="demuxing__decoding_8c.html#a7331e302ea7bb48e0b605a069576e135">pix_fmt</a>, <span class="keywordtype">int</span> <a name="a109"></a><a class="code" href="demuxing__decoding_8c.html#a2474a5474cbff19523a51eb1de01cda4">width</a>, <span class="keywordtype">int</span> <a name="a110"></a><a class="code" href="demuxing__decoding_8c.html#ad12fc34ce789bce6c8a05d8a17138534">height</a>)</div><div class="line">{</div><div class="line">    <a class="code" href="structAVFrame.html">AVFrame</a> *picture;</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line"></div><div class="line">    picture = <a class="code" href="group__lavu__frame.html#gac700017c5270c79c1e1befdeeb008b2f">av_frame_alloc</a>();</div><div class="line">    <span class="keywordflow">if</span> (!picture)</div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line"></div><div class="line">    picture-&gt;<a class="code" href="structAVFrame.html#aed14fa772ce46881020fd1545c86432c">format</a> = <a class="code" href="demuxing__decoding_8c.html#a7331e302ea7bb48e0b605a069576e135">pix_fmt</a>;</div><div class="line">    picture-&gt;<a name="a111"></a><a class="code" href="structAVFrame.html#a1e71ce60cedd5f3b6811714a9f7f9e0a">width</a>  = <a class="code" href="demuxing__decoding_8c.html#a2474a5474cbff19523a51eb1de01cda4">width</a>;</div><div class="line">    picture-&gt;<a name="a112"></a><a class="code" href="structAVFrame.html#a3f89733f429c98ba5bc64373fb0a3f13">height</a> = <a class="code" href="demuxing__decoding_8c.html#ad12fc34ce789bce6c8a05d8a17138534">height</a>;</div><div class="line"></div><div class="line">    <span class="comment">/* allocate the buffers for the frame data */</span></div><div class="line">    ret = <a class="code" href="group__lavu__frame.html#ga6b1acbfa82c79bf7fd78d868572f0ceb">av_frame_get_buffer</a>(picture, 32);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not allocate frame data.\n&quot;</span>);</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> picture;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a113"></a><a class="code" href="muxing_8c.html#a34f7b1a6fc3698c190131c3df2e85903">open_video</a>(<a class="code" href="structAVFormatContext.html">AVFormatContext</a> *oc, <a class="code" href="structAVCodec.html">AVCodec</a> *codec, <a class="code" href="structOutputStream.html">OutputStream</a> *ost, <a class="code" href="group__lavu__dict.html#ga1d7cc0833bee918994a600556410315f">AVDictionary</a> *opt_arg)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    <a class="code" href="structAVCodecContext.html">AVCodecContext</a> *c = ost-&gt;<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>;</div><div class="line">    <a class="code" href="group__lavu__dict.html#ga1d7cc0833bee918994a600556410315f">AVDictionary</a> *opt = NULL;</div><div class="line"></div><div class="line">    <a class="code" href="group__lavu__dict.html#ga59a6372b124b306e3a2233723c5cdc78">av_dict_copy</a>(&amp;opt, opt_arg, 0);</div><div class="line"></div><div class="line">    <span class="comment">/* open the codec */</span></div><div class="line">    ret = <a class="code" href="group__lavc__core.html#ga11f785a188d7d9df71621001465b0f1d">avcodec_open2</a>(c, codec, &amp;opt);</div><div class="line">    <a class="code" href="group__lavu__dict.html#ga1bafd682b1fbb90e48a4cc3814b820f7">av_dict_free</a>(&amp;opt);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not open video codec: %s\n&quot;</span>, <a class="code" href="group__lavu__error.html#gac4f6e109c242c81aeee21868d3f35e12">av_err2str</a>(ret));</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* allocate and init a re-usable frame */</span></div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a> = <a class="code" href="muxing_8c.html#a03824343735e44b58ec03ff1691f8b45">alloc_picture</a>(c-&gt;<a class="code" href="structAVCodecContext.html#a0425c77b3d06d71e5db88b1d7e1b37f2">pix_fmt</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0d8f46461754e8abea0847dcbc41b956">width</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0449afd803eb107bd4dbc8b5ea22e363">height</a>);</div><div class="line">    <span class="keywordflow">if</span> (!ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not allocate video frame\n&quot;</span>);</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* If the output format is not YUV420P, then a temporary YUV420P</span></div><div class="line"><span class="comment">     * picture is needed too. It is then converted to the required</span></div><div class="line"><span class="comment">     * output format. */</span></div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a> = NULL;</div><div class="line">    <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structAVCodecContext.html#a0425c77b3d06d71e5db88b1d7e1b37f2">pix_fmt</a> != <a name="a114"></a><a class="code" href="pixfmt_8h.html#a9a8e335cf3be472042bc9f0cf80cd4c5a1aa7677092740d8def31655b5d7f0cc2">AV_PIX_FMT_YUV420P</a>) {</div><div class="line">        ost-&gt;<a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a> = <a class="code" href="muxing_8c.html#a03824343735e44b58ec03ff1691f8b45">alloc_picture</a>(<a class="code" href="pixfmt_8h.html#a9a8e335cf3be472042bc9f0cf80cd4c5a1aa7677092740d8def31655b5d7f0cc2">AV_PIX_FMT_YUV420P</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0d8f46461754e8abea0847dcbc41b956">width</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0449afd803eb107bd4dbc8b5ea22e363">height</a>);</div><div class="line">        <span class="keywordflow">if</span> (!ost-&gt;<a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a>) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not allocate temporary picture\n&quot;</span>);</div><div class="line">            exit(1);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* copy the stream parameters to the muxer */</span></div><div class="line">    ret = <a class="code" href="group__lavc__core.html#ga0c7058f764778615e7978a1821ab3cfe">avcodec_parameters_from_context</a>(ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>-&gt;<a class="code" href="structAVStream.html#a12826d21779289356722971d362c583c">codecpar</a>, c);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not copy the stream parameters\n&quot;</span>);</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Prepare a dummy image. */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a115"></a><a class="code" href="muxing_8c.html#acc346658c36a422fc9ab42bbb976138e">fill_yuv_image</a>(<a class="code" href="structAVFrame.html">AVFrame</a> *pict, <span class="keywordtype">int</span> frame_index,</div><div class="line">                           <span class="keywordtype">int</span> <a class="code" href="demuxing__decoding_8c.html#a2474a5474cbff19523a51eb1de01cda4">width</a>, <span class="keywordtype">int</span> <a class="code" href="demuxing__decoding_8c.html#ad12fc34ce789bce6c8a05d8a17138534">height</a>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> x, y, i;</div><div class="line"></div><div class="line">    i = frame_index;</div><div class="line"></div><div class="line">    <span class="comment">/* Y */</span></div><div class="line">    <span class="keywordflow">for</span> (y = 0; y &lt; <a class="code" href="demuxing__decoding_8c.html#ad12fc34ce789bce6c8a05d8a17138534">height</a>; y++)</div><div class="line">        <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="demuxing__decoding_8c.html#a2474a5474cbff19523a51eb1de01cda4">width</a>; x++)</div><div class="line">            pict-&gt;<a class="code" href="structAVFrame.html#a1d0f65014a8d1bf78cec8cbed2304992">data</a>[0][y * pict-&gt;<a name="a116"></a><a class="code" href="structAVFrame.html#aa52bfc6605f6a3059a0c3226cc0f6567">linesize</a>[0] + x] = x + y + i * 3;</div><div class="line"></div><div class="line">    <span class="comment">/* Cb and Cr */</span></div><div class="line">    for (y = 0; y &lt; height / 2; y++) {</div><div class="line">        <span class="keywordflow">for</span> (x = 0; x &lt; width / 2; x++) {</div><div class="line">            pict-&gt;<a class="code" href="structAVFrame.html#a1d0f65014a8d1bf78cec8cbed2304992">data</a>[1][y * pict-&gt;<a class="code" href="structAVFrame.html#aa52bfc6605f6a3059a0c3226cc0f6567">linesize</a>[1] + x] = 128 + y + i * 2;</div><div class="line">            pict-&gt;<a class="code" href="structAVFrame.html#a1d0f65014a8d1bf78cec8cbed2304992">data</a>[2][y * pict-&gt;<a class="code" href="structAVFrame.html#aa52bfc6605f6a3059a0c3226cc0f6567">linesize</a>[2] + x] = 64 + x + i * 5;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="structAVFrame.html">AVFrame</a> *<a name="a117"></a><a class="code" href="muxing_8c.html#a2a1515bfcdc1e221407cba978bcad1f0">get_video_frame</a>(<a class="code" href="structOutputStream.html">OutputStream</a> *ost)</div><div class="line">{</div><div class="line">    <a class="code" href="structAVCodecContext.html">AVCodecContext</a> *c = ost-&gt;<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>;</div><div class="line"></div><div class="line">    <span class="comment">/* check if we want to generate more frames */</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__lavu__math.html#ga151744358fff630942b926e67e67c415">av_compare_ts</a>(ost-&gt;<a class="code" href="structOutputStream.html#aaa3b9001e4dac709017237c1c177cd0a">next_pts</a>, c-&gt;<a class="code" href="structAVCodecContext.html#ab7bfeb9fa5840aac090e2b0bd0ef7589">time_base</a>,</div><div class="line">                      <a class="code" href="muxing_8c.html#ace0cad5fe744009aeaa62eb1fbb31831">STREAM_DURATION</a>, (<a class="code" href="structAVRational.html">AVRational</a>){ 1, 1 }) &gt;= 0)</div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line"></div><div class="line">    <span class="comment">/* when we pass a frame to the encoder, it may keep a reference to it</span></div><div class="line"><span class="comment">     * internally; make sure we do not overwrite it here */</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__lavu__frame.html#gadd5417c06f5a6b419b0dbd8f0ff363fd">av_frame_make_writable</a>(ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>) &lt; 0)</div><div class="line">        exit(1);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structAVCodecContext.html#a0425c77b3d06d71e5db88b1d7e1b37f2">pix_fmt</a> != <a class="code" href="pixfmt_8h.html#a9a8e335cf3be472042bc9f0cf80cd4c5a1aa7677092740d8def31655b5d7f0cc2">AV_PIX_FMT_YUV420P</a>) {</div><div class="line">        <span class="comment">/* as we only generate a YUV420P picture, we must convert it</span></div><div class="line"><span class="comment">         * to the codec pixel format if needed */</span></div><div class="line">        <span class="keywordflow">if</span> (!ost-&gt;<a class="code" href="structOutputStream.html#a87e6c2172dab3143e4857aaaf6558573">sws_ctx</a>) {</div><div class="line">            ost-&gt;<a class="code" href="structOutputStream.html#a87e6c2172dab3143e4857aaaf6558573">sws_ctx</a> = <a name="a118"></a><a class="code" href="group__libsws.html#gaf360d1a9e0e60f906f74d7d44f9abfdd">sws_getContext</a>(c-&gt;<a class="code" href="structAVCodecContext.html#a0d8f46461754e8abea0847dcbc41b956">width</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0449afd803eb107bd4dbc8b5ea22e363">height</a>,</div><div class="line">                                          <a class="code" href="pixfmt_8h.html#a9a8e335cf3be472042bc9f0cf80cd4c5a1aa7677092740d8def31655b5d7f0cc2">AV_PIX_FMT_YUV420P</a>,</div><div class="line">                                          c-&gt;<a class="code" href="structAVCodecContext.html#a0d8f46461754e8abea0847dcbc41b956">width</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0449afd803eb107bd4dbc8b5ea22e363">height</a>,</div><div class="line">                                          c-&gt;<a class="code" href="structAVCodecContext.html#a0425c77b3d06d71e5db88b1d7e1b37f2">pix_fmt</a>,</div><div class="line">                                          <a name="a119"></a><a class="code" href="muxing_8c.html#ab746bcb79e75e498c4925ccd72a34f63">SCALE_FLAGS</a>, NULL, NULL, NULL);</div><div class="line">            <span class="keywordflow">if</span> (!ost-&gt;<a class="code" href="structOutputStream.html#a87e6c2172dab3143e4857aaaf6558573">sws_ctx</a>) {</div><div class="line">                fprintf(stderr,</div><div class="line">                        <span class="stringliteral">&quot;Could not initialize the conversion context\n&quot;</span>);</div><div class="line">                exit(1);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <a class="code" href="muxing_8c.html#acc346658c36a422fc9ab42bbb976138e">fill_yuv_image</a>(ost-&gt;<a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a>, ost-&gt;<a class="code" href="structOutputStream.html#aaa3b9001e4dac709017237c1c177cd0a">next_pts</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0d8f46461754e8abea0847dcbc41b956">width</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0449afd803eb107bd4dbc8b5ea22e363">height</a>);</div><div class="line">        <a name="a120"></a><a class="code" href="group__libsws.html#gae531c9754c9205d90ad6800015046d74">sws_scale</a>(ost-&gt;<a class="code" href="structOutputStream.html#a87e6c2172dab3143e4857aaaf6558573">sws_ctx</a>, (<span class="keyword">const</span> uint8_t * <span class="keyword">const</span> *) ost-&gt;<a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a>-&gt;<a class="code" href="structAVFrame.html#a1d0f65014a8d1bf78cec8cbed2304992">data</a>,</div><div class="line">                  ost-&gt;<a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a>-&gt;<a class="code" href="structAVFrame.html#aa52bfc6605f6a3059a0c3226cc0f6567">linesize</a>, 0, c-&gt;<a class="code" href="structAVCodecContext.html#a0449afd803eb107bd4dbc8b5ea22e363">height</a>, ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>-&gt;<a class="code" href="structAVFrame.html#a1d0f65014a8d1bf78cec8cbed2304992">data</a>,</div><div class="line">                  ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>-&gt;<a class="code" href="structAVFrame.html#aa52bfc6605f6a3059a0c3226cc0f6567">linesize</a>);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <a class="code" href="muxing_8c.html#acc346658c36a422fc9ab42bbb976138e">fill_yuv_image</a>(ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>, ost-&gt;<a class="code" href="structOutputStream.html#aaa3b9001e4dac709017237c1c177cd0a">next_pts</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0d8f46461754e8abea0847dcbc41b956">width</a>, c-&gt;<a class="code" href="structAVCodecContext.html#a0449afd803eb107bd4dbc8b5ea22e363">height</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>-&gt;<a class="code" href="structAVFrame.html#a0452833e3ab6ddd7acbf82817a7818a4">pts</a> = ost-&gt;<a class="code" href="structOutputStream.html#aaa3b9001e4dac709017237c1c177cd0a">next_pts</a>++;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * encode one video frame and send it to the muxer</span></div><div class="line"><span class="comment"> * return 1 when encoding is finished, 0 otherwise</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a121"></a><a class="code" href="muxing_8c.html#a435288caae5076cca3273215cb6ad395">write_video_frame</a>(<a class="code" href="structAVFormatContext.html">AVFormatContext</a> *oc, <a class="code" href="structOutputStream.html">OutputStream</a> *ost)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    <a class="code" href="structAVCodecContext.html">AVCodecContext</a> *c;</div><div class="line">    <a class="code" href="structAVFrame.html">AVFrame</a> *<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>;</div><div class="line">    <span class="keywordtype">int</span> got_packet = 0;</div><div class="line">    <a class="code" href="structAVPacket.html">AVPacket</a> pkt = { 0 };</div><div class="line"></div><div class="line">    c = ost-&gt;<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>;</div><div class="line"></div><div class="line">    frame = <a class="code" href="muxing_8c.html#a2a1515bfcdc1e221407cba978bcad1f0">get_video_frame</a>(ost);</div><div class="line"></div><div class="line">    <a class="code" href="group__lavc__packet.html#gac9cb9756175b96e7441575803757fb73">av_init_packet</a>(&amp;pkt);</div><div class="line"></div><div class="line">    <span class="comment">/* encode the image */</span></div><div class="line">    ret = <a name="a122"></a><a class="code" href="group__lavc__encoding.html#ga2c08a4729f72f9bdac41b5533c4f2642">avcodec_encode_video2</a>(c, &amp;pkt, frame, &amp;got_packet);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error encoding video frame: %s\n&quot;</span>, <a class="code" href="group__lavu__error.html#gac4f6e109c242c81aeee21868d3f35e12">av_err2str</a>(ret));</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (got_packet) {</div><div class="line">        ret = <a class="code" href="muxing_8c.html#ab85f450fd9ee7aad777fc135b62dd3cd">write_frame</a>(oc, &amp;c-&gt;<a class="code" href="structAVCodecContext.html#ab7bfeb9fa5840aac090e2b0bd0ef7589">time_base</a>, ost-&gt;<a class="code" href="structOutputStream.html#ac11510a2eeed3e6a14f0fbc85db2e088">st</a>, &amp;pkt);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        ret = 0;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error while writing video frame: %s\n&quot;</span>, <a class="code" href="group__lavu__error.html#gac4f6e109c242c81aeee21868d3f35e12">av_err2str</a>(ret));</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (frame || got_packet) ? 0 : 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a123"></a><a class="code" href="muxing_8c.html#a92d8b2751255677797d807161fae9d19">close_stream</a>(<a class="code" href="structAVFormatContext.html">AVFormatContext</a> *oc, <a class="code" href="structOutputStream.html">OutputStream</a> *ost)</div><div class="line">{</div><div class="line">    <a name="a124"></a><a class="code" href="group__lavc__core.html#gaf869d0829ed607cec3a4a02a1c7026b3">avcodec_free_context</a>(&amp;ost-&gt;<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>);</div><div class="line">    <a name="a125"></a><a class="code" href="group__lavu__frame.html#ga979d73f3228814aee56aeca0636e37cc">av_frame_free</a>(&amp;ost-&gt;<a class="code" href="structOutputStream.html#a09ee2998f47d0e69c99dee8a6f71105a">frame</a>);</div><div class="line">    <a class="code" href="group__lavu__frame.html#ga979d73f3228814aee56aeca0636e37cc">av_frame_free</a>(&amp;ost-&gt;<a class="code" href="structOutputStream.html#a2ffa8b8369d869e8a440c2611ba91ae2">tmp_frame</a>);</div><div class="line">    <a name="a126"></a><a class="code" href="group__libsws.html#gad3af0ca76f071dbe0173444db9882932">sws_freeContext</a>(ost-&gt;<a class="code" href="structOutputStream.html#a87e6c2172dab3143e4857aaaf6558573">sws_ctx</a>);</div><div class="line">    <a name="a127"></a><a class="code" href="group__lswr.html#ga818f7d78b1ad7d8d5b70de374b668c34">swr_free</a>(&amp;ost-&gt;<a class="code" href="structOutputStream.html#a1a5c19db8f6a49a4d7a14168e4b73ec1">swr_ctx</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**************************************************************/</span></div><div class="line"><span class="comment">/* media file output */</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a128"></a><a class="code" href="muxing_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div><div class="line">{</div><div class="line">    <a class="code" href="structOutputStream.html">OutputStream</a> video_st = { 0 }, audio_st = { 0 };</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *filename;</div><div class="line">    <a name="_a129"></a><a class="code" href="structAVOutputFormat.html">AVOutputFormat</a> *fmt;</div><div class="line">    <a class="code" href="structAVFormatContext.html">AVFormatContext</a> *oc;</div><div class="line">    <a class="code" href="structAVCodec.html">AVCodec</a> *audio_codec, *video_codec;</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    <span class="keywordtype">int</span> have_video = 0, have_audio = 0;</div><div class="line">    <span class="keywordtype">int</span> encode_video = 0, encode_audio = 0;</div><div class="line">    <a class="code" href="group__lavu__dict.html#ga1d7cc0833bee918994a600556410315f">AVDictionary</a> *opt = NULL;</div><div class="line">    <span class="keywordtype">int</span> i;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize libavcodec, and register all codecs and formats. */</span></div><div class="line">    <a name="a130"></a><a class="code" href="group__lavf__core.html#ga917265caec45ef5a0646356ed1a507e3">av_register_all</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (argc &lt; 2) {</div><div class="line">        printf(<span class="stringliteral">&quot;usage: %s output_file\n&quot;</span></div><div class="line">               <span class="stringliteral">&quot;API example program to output a media file with libavformat.\n&quot;</span></div><div class="line">               <span class="stringliteral">&quot;This program generates a synthetic audio and video stream, encodes and\n&quot;</span></div><div class="line">               <span class="stringliteral">&quot;muxes them into a file named output_file.\n&quot;</span></div><div class="line">               <span class="stringliteral">&quot;The output format is automatically guessed according to the file extension.\n&quot;</span></div><div class="line">               <span class="stringliteral">&quot;Raw images can also be output by using &#39;%%d&#39; in the filename.\n&quot;</span></div><div class="line">               <span class="stringliteral">&quot;\n&quot;</span>, argv[0]);</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    filename = argv[1];</div><div class="line">    <span class="keywordflow">for</span> (i = 2; i+1 &lt; argc; i+=2) {</div><div class="line">        <span class="keywordflow">if</span> (!strcmp(argv[i], <span class="stringliteral">&quot;-flags&quot;</span>) || !strcmp(argv[i], <span class="stringliteral">&quot;-fflags&quot;</span>))</div><div class="line">            <a name="a131"></a><a class="code" href="group__lavu__dict.html#ga8d9c2de72b310cef8e6a28c9cd3acbbe">av_dict_set</a>(&amp;opt, argv[i]+1, argv[i+1], 0);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* allocate the output media context */</span></div><div class="line">    <a name="a132"></a><a class="code" href="avformat_8h.html#a6ddf3d982feb45fa5081420ee911f5d5">avformat_alloc_output_context2</a>(&amp;oc, NULL, NULL, filename);</div><div class="line">    <span class="keywordflow">if</span> (!oc) {</div><div class="line">        printf(<span class="stringliteral">&quot;Could not deduce output format from file extension: using MPEG.\n&quot;</span>);</div><div class="line">        <a class="code" href="avformat_8h.html#a6ddf3d982feb45fa5081420ee911f5d5">avformat_alloc_output_context2</a>(&amp;oc, NULL, <span class="stringliteral">&quot;mpeg&quot;</span>, filename);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (!oc)</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line"></div><div class="line">    fmt = oc-&gt;<a class="code" href="structAVFormatContext.html#a20d80ac07e38ff5c268d15aaf2798b98">oformat</a>;</div><div class="line"></div><div class="line">    <span class="comment">/* Add the audio and video streams using the default format codecs</span></div><div class="line"><span class="comment">     * and initialize the codecs. */</span></div><div class="line">    <span class="keywordflow">if</span> (fmt-&gt;<a name="a133"></a><a class="code" href="structAVOutputFormat.html#a1354a9c8542b1b698157218336bd4754">video_codec</a> != <a name="a134"></a><a class="code" href="group__lavc__core.html#ggaadca229ad2c20e060a14fec08a5cc7cea48761c50b102343e2648c3e28a94e7ab">AV_CODEC_ID_NONE</a>) {</div><div class="line">        <a class="code" href="muxing_8c.html#aead090f3b6525cfdfa572f18f7575219">add_stream</a>(&amp;video_st, oc, &amp;video_codec, fmt-&gt;<a class="code" href="structAVOutputFormat.html#a1354a9c8542b1b698157218336bd4754">video_codec</a>);</div><div class="line">        have_video = 1;</div><div class="line">        encode_video = 1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (fmt-&gt;<a name="a135"></a><a class="code" href="structAVOutputFormat.html#a2e4fff0aa061984d586ea08ecad96141">audio_codec</a> != <a class="code" href="group__lavc__core.html#ggaadca229ad2c20e060a14fec08a5cc7cea48761c50b102343e2648c3e28a94e7ab">AV_CODEC_ID_NONE</a>) {</div><div class="line">        <a class="code" href="muxing_8c.html#aead090f3b6525cfdfa572f18f7575219">add_stream</a>(&amp;audio_st, oc, &amp;audio_codec, fmt-&gt;<a class="code" href="structAVOutputFormat.html#a2e4fff0aa061984d586ea08ecad96141">audio_codec</a>);</div><div class="line">        have_audio = 1;</div><div class="line">        encode_audio = 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Now that all the parameters are set, we can open the audio and</span></div><div class="line"><span class="comment">     * video codecs and allocate the necessary encode buffers. */</span></div><div class="line">    <span class="keywordflow">if</span> (have_video)</div><div class="line">        <a class="code" href="muxing_8c.html#a34f7b1a6fc3698c190131c3df2e85903">open_video</a>(oc, video_codec, &amp;video_st, opt);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (have_audio)</div><div class="line">        <a class="code" href="muxing_8c.html#ae7697b74a6a8605a91487b43e31f29be">open_audio</a>(oc, audio_codec, &amp;audio_st, opt);</div><div class="line"></div><div class="line">    <a name="a136"></a><a class="code" href="group__lavf__misc.html#gae2645941f2dc779c307eb6314fd39f10">av_dump_format</a>(oc, 0, filename, 1);</div><div class="line"></div><div class="line">    <span class="comment">/* open the output file, if needed */</span></div><div class="line">    <span class="keywordflow">if</span> (!(fmt-&gt;<a class="code" href="structAVOutputFormat.html#aad55a00e728a020c1dcfaaf695320445">flags</a> &amp; <a name="a137"></a><a class="code" href="avformat_8h.html#a752cce390d480521919aa5d8be24ac0b">AVFMT_NOFILE</a>)) {</div><div class="line">        ret = <a name="a138"></a><a class="code" href="avio_8h.html#a371a670112abc5f3e15bc570da076301">avio_open</a>(&amp;oc-&gt;<a name="a139"></a><a class="code" href="structAVFormatContext.html#a1e7324262b6b78522e52064daaa7bc87">pb</a>, filename, <a name="a140"></a><a class="code" href="avio_8h.html#a5c9308f296545a8f3b7687d277a6dabc">AVIO_FLAG_WRITE</a>);</div><div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not open &#39;%s&#39;: %s\n&quot;</span>, filename,</div><div class="line">                    <a class="code" href="group__lavu__error.html#gac4f6e109c242c81aeee21868d3f35e12">av_err2str</a>(ret));</div><div class="line">            <span class="keywordflow">return</span> 1;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Write the stream header, if any. */</span></div><div class="line">    ret = <a name="a141"></a><a class="code" href="group__lavf__encoding.html#ga18b7b10bb5b94c4842de18166bc677cb">avformat_write_header</a>(oc, &amp;opt);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error occurred when opening output file: %s\n&quot;</span>,</div><div class="line">                <a class="code" href="group__lavu__error.html#gac4f6e109c242c81aeee21868d3f35e12">av_err2str</a>(ret));</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (encode_video || encode_audio) {</div><div class="line">        <span class="comment">/* select the stream to encode */</span></div><div class="line">        <span class="keywordflow">if</span> (encode_video &amp;&amp;</div><div class="line">            (!encode_audio || <a class="code" href="group__lavu__math.html#ga151744358fff630942b926e67e67c415">av_compare_ts</a>(video_st.<a class="code" href="structOutputStream.html#aaa3b9001e4dac709017237c1c177cd0a">next_pts</a>, video_st.<a class="code" href="structOutputStream.html#aefd92ac60c5cbc6d9f7f5ae7e9bec19d">enc</a>-&gt;<a class="code" href="structAVCodecContext.html#ab7bfeb9fa5840aac090e2b0bd0ef7589">time_base</a>,</div><div class="line">                                            audio_st.next_pts, audio_st.enc-&gt;time_base) &lt;= 0)) {</div><div class="line">            encode_video = !<a class="code" href="muxing_8c.html#a435288caae5076cca3273215cb6ad395">write_video_frame</a>(oc, &amp;video_st);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            encode_audio = !<a class="code" href="muxing_8c.html#a789f35413429ab70610c90c22fc7a4d3">write_audio_frame</a>(oc, &amp;audio_st);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Write the trailer, if any. The trailer must be written before you</span></div><div class="line"><span class="comment">     * close the CodecContexts open when you wrote the header; otherwise</span></div><div class="line"><span class="comment">     * av_write_trailer() may try to use memory that was freed on</span></div><div class="line"><span class="comment">     * av_codec_close(). */</span></div><div class="line">    <a name="a142"></a><a class="code" href="group__lavf__encoding.html#ga7f14007e7dc8f481f054b21614dfec13">av_write_trailer</a>(oc);</div><div class="line"></div><div class="line">    <span class="comment">/* Close each codec. */</span></div><div class="line">    <span class="keywordflow">if</span> (have_video)</div><div class="line">        <a class="code" href="muxing_8c.html#a92d8b2751255677797d807161fae9d19">close_stream</a>(oc, &amp;video_st);</div><div class="line">    <span class="keywordflow">if</span> (have_audio)</div><div class="line">        <a class="code" href="muxing_8c.html#a92d8b2751255677797d807161fae9d19">close_stream</a>(oc, &amp;audio_st);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!(fmt-&gt;<a class="code" href="structAVOutputFormat.html#aad55a00e728a020c1dcfaaf695320445">flags</a> &amp; <a class="code" href="avformat_8h.html#a752cce390d480521919aa5d8be24ac0b">AVFMT_NOFILE</a>))</div><div class="line">        <span class="comment">/* Close the output file. */</span></div><div class="line">        <a name="a143"></a><a class="code" href="avio_8h.html#ae118a1f37f1e48617609ead9910aac15">avio_closep</a>(&amp;oc-&gt;<a class="code" href="structAVFormatContext.html#a1e7324262b6b78522e52064daaa7bc87">pb</a>);</div><div class="line"></div><div class="line">    <span class="comment">/* free the stream */</span></div><div class="line">    <a name="a144"></a><a class="code" href="group__lavf__core.html#gac2990b13b68e831a408fce8e1d0d6445">avformat_free_context</a>(oc);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
